---
title: "Regression modelling of self-reported depression diagnosis"
output: 
 html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(survey)
library(srvyr)
#library(svyVGAM)
library(purrr)
library(dplyr)
library(readr)
library(forcats)
library(gtsummary)
library(surveyCV)
library(modelr)
library(caret)



# Set options for allowing a single observation per stratum 
options(survey.lonely.psu = "adjust")
```


```{r include = FALSE}
load(file = "./data/brfss_design.Rdata")
```


### Crude model with exposures only
```{r}
crude_mod_depr = svyglm(depression ~ sex + children, # exposures
       brfss_design,
       family = quasibinomial())
crude_mod_depr %>% broom::tidy(exponentiate=T, conf.int = T, conf.level=0.95)
```

### Model controlling for demographic variables
```{r}
mod2_depr = svyglm(depression ~ sex + children + # exposures
         race + age + marital_status, # demographic covariates
       brfss_design,
       family = quasibinomial())
mod2_depr %>% broom::tidy(exponentiate=T, conf.int = T, conf.level=0.95)
```

### Model controlling for demographic and socioeconomic variables
```{r}
mod3_depr = svyglm(depression ~ sex + children + # exposures
         race + age + marital_status + # demographic covariates
         education + income + employment + homeownership, # socioeconomic covariates, 
       brfss_design,
       family = quasibinomial()) 
mod3_depr %>% broom::tidy(exponentiate=T, conf.int = T, conf.level=0.95)
```


### Model controlling for demographic, socioeconomic, and health variables
```{r}
full_mod_depr = svyglm(depression ~ sex + children + # exposures
           race + age + marital_status + # demographic covariates
           education + income + employment + homeownership + # socioeconomic covariates
           general_health + exercise, # health-related covariates
       brfss_design,
       family = quasibinomial())  

full_mod_depr %>% broom::tidy(exponentiate=T, conf.int = T, conf.level=0.95)
```

### Model Comparison
(AIC for score-based comparison for inference purposes and cross validation for prediction purpose?)
```{r}
AIC(full_mod_depr)
```


### Subsetted analysis by gender
Here we are interested in our second exposure, the number of children in the household. Specifically, we are interested in if it affects self-reported depression diagnosis differently for men and women. 

```{r}
## Cross validation first try
cv <- crossv_kfold(as.data.frame(brfss_design), k = 5)
cv

models1 <- map(cv$train, ~lm(depression ~ children, data = .))
get_pred <- function(model, test_data){
  data <- as.data.frame(test_data)
  pred <- add_predictions(data, model)
  return(pred)
}

pred1 <- map2_df(models1, cv$test, get_pred, .id = "sex")

MSE1 <- pred1 %>% group_by(sex) %>% 
  summarise(MSE = mean((depression - pred)^2))
MSE1
```
```{r}
## Cross validation second try
data_to_use = 
  read_csv("./data/cleaned_brfss21.csv") %>% 
  mutate(
    new_depression = case_when(depression == "no" ~ 0,
                                depression == "yes" ~ 1),
    depr_num = as.numeric(new_depression))
head(data_to_use)
typeof(data_to_use$depr_num)

set.seed(2022)

random_sample <- createDataPartition(data_to_use$depr_num,
                                    p = 0.8, list = FALSE)
training_dataset <- data_to_use[random_sample, ]

testing_dataset <- data_to_use[-random_sample, ]

model <- lm(depr_num ~., data = data_to_use)

predictions <- predict(model, testing_dataset)

data.frame( R2 = R2(predictions, testing_dataset $ depr_num),
            RMSE = RMSE(predictions, testing_dataset$depr_num),
            MAE = MAE(predictions, testing_dataset $ depr_num))

```






